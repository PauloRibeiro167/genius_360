#!/bin/bash

echo "ğŸš€ Iniciando Genius360..."

# Verifica se containers estÃ£o rodando
if ! docker-compose ps | grep "Up" > /dev/null; then
  echo "ğŸ“¦ Iniciando containers..."
  docker-compose up -d
  echo "â³ Aguardando serviÃ§os iniciarem..."
  sleep 5
else
  echo "âœ… Containers jÃ¡ estÃ£o em execuÃ§Ã£o"
fi

# Verifica se o banco de dados estÃ¡ pronto
echo "ğŸ” Verificando conexÃ£o com o banco de dados..."
if ! docker-compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
  echo "âš ï¸ Esperando banco de dados iniciar..."
  for i in {1..10}; do
    sleep 3
    echo -n "."
    if docker-compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
      echo " âœ…"
      break
    fi
    if [ $i -eq 10 ]; then
      echo " âŒ"
      echo "âŒ Banco de dados nÃ£o respondeu no tempo esperado"
      exit 1
    fi
  done
fi

# Inicializa o banco de dados se necessÃ¡rio
if ! docker-compose exec -T web rails db:version > /dev/null 2>&1; then
  echo "ğŸ—„ï¸ Inicializando banco de dados..."
  docker-compose exec -T web rails db:create db:migrate db:seed
fi

echo "ğŸŒ Verificando servidor Rails..."
if curl -s http://localhost:3000 -o /dev/null 2>&1; then
  echo "âœ… Servidor Rails estÃ¡ respondendo!"
else
  echo "âš ï¸ Servidor Rails nÃ£o estÃ¡ respondendo. Verificando logs..."
  docker-compose logs --tail=20 web
  echo ""
  echo "âš ï¸ Talvez seja necessÃ¡rio reiniciar o servidor. Use: make restart"
fi

echo -e "\nâœ… Sistema Genius360 estÃ¡ pronto!"
echo "ğŸŒ Acesse: http://localhost:3000"
echo "ğŸš Para acessar o terminal do container web: make shell"
echo "ğŸ“‹ Para ver todos os comandos disponÃ­veis: make help"
