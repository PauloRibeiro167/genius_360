.PHONY: exec down build clean help up ps restart status logs rails-console db-console db-migrate db-reset bash setup performance update test routes start shell debug fix-server server-start server-stop server-restart server-status

help:
	@echo "Comandos disponÃ­veis:"
	@echo "  make start        - Inicia todos os serviÃ§os e verifica funcionamento"
	@echo "  make exec         - Inicia os containers e abre o console web"
	@echo "  make shell        - Abre o terminal no container web (sem reiniciar serviÃ§os)"
	@echo "  make down         - Para todos os containers"
	@echo "  make build        - Rebuilda os containers"
	@echo "  make clean        - Para os containers e remove volumes/imagens"
	@echo "  make up           - Inicia os serviÃ§os em background"
	@echo "  make ps           - Lista os containers em execuÃ§Ã£o"
	@echo "  make restart      - Reinicia os serviÃ§os"
	@echo "  make status       - Verifica o status dos serviÃ§os"
	@echo "  make logs         - Exibe os logs dos containers"
	@echo "  make rails-console- Abre o console Rails"
	@echo "  make db-console   - Abre o console PostgreSQL"
	@echo "  make db-migrate   - Executa migraÃ§Ãµes do banco de dados"
	@echo "  make db-reset     - Recria o banco de dados"
	@echo "  make bash         - Abre um terminal no container web"
	@echo "  make debug        - Executa diagnÃ³stico completo do ambiente"
	@echo "  make fix-server   - Corrige problemas com o servidor Rails"
	@echo "  make server-start - Inicia o servidor Rails no container"
	@echo "  make server-stop  - Para o servidor Rails no container"
	@echo "  make server-restart - Reinicia o servidor Rails no container"
	@echo "  make server-status  - Verifica o status do servidor Rails"

up:
	@echo "ğŸš€ Iniciando serviÃ§os..."
	@docker-compose up --remove-orphans -d
	@echo "âœ¨ ServiÃ§os iniciados em background"

ps:
	@docker-compose ps

restart:
	@echo "ğŸ”„ Reiniciando serviÃ§os..."
	@bash scripts/restart_services.sh

exec:
	@echo "ğŸš€ Iniciando ambiente Genius360..."
	@docker-compose up -d --remove-orphans
	@echo "â³ Aguardando serviÃ§os..."
	@sleep 5
	@docker-compose exec web bash

down:
	@echo "ğŸ›‘ Parando containers..."
	@docker-compose down

build:
	@echo "ğŸ—ï¸ Reconstruindo containers..."
	@docker-compose build
	@echo "âœ¨ Build completado"

clean:
	@echo "ğŸ§¹ Limpando ambiente..."
	@docker-compose down -v --rmi all --remove-orphans
	@echo "ğŸ—‘ï¸ Containers, volumes e imagens removidos"

status:
	@echo "ğŸ“Š Verificando status dos serviÃ§os..."
	@bash scripts/check_status.sh

logs:
	@docker-compose logs -f

rails-console:
	@echo "ğŸ›¤ï¸ Abrindo console Rails..."
	@docker-compose exec web rails console

db-console:
	@echo "ğŸ—„ï¸ Abrindo console PostgreSQL..."
	@docker-compose exec postgres psql -U postgres -d genius360_development

db-migrate:
	@echo "ğŸ”„ Executando migraÃ§Ãµes do banco de dados..."
	@docker-compose exec web rails db:migrate

db-reset:
	@echo "âš ï¸ Recriando banco de dados... âš ï¸"
	@docker-compose exec web rails db:drop db:create db:migrate db:seed

bash:
	@echo "ğŸš Abrindo terminal no container web..."
	@docker-compose exec web bash

setup:
	@echo "ğŸ› ï¸ Configurando ambiente de desenvolvimento..."
	@bash scripts/development_setup.sh

performance:
	@echo "ğŸ“Š Verificando performance do sistema..."
	@bash scripts/performance_check.sh

update:
	@echo "ğŸ”„ Atualizando dependÃªncias..."
	@docker-compose exec web bundle update
	@docker-compose exec web yarn upgrade || echo "Sem yarn no projeto"
	@echo "âœ… DependÃªncias atualizadas"

test:
	@echo "ğŸ§ª Executando testes..."
	@docker-compose exec web rails test

routes:
	@echo "ğŸ›£ï¸ Rotas da aplicaÃ§Ã£o:"
	@docker-compose exec web rails routes | grep -v "^#"

start:
	@bash start.sh

shell:
	@echo "ğŸš Abrindo terminal no container web..."
	@docker-compose exec web bash || { echo "âš ï¸ Container web nÃ£o estÃ¡ em execuÃ§Ã£o. Iniciando serviÃ§os..."; make exec; }

debug:
	@echo "ğŸ” Executando diagnÃ³stico do ambiente..."
	@bash scripts/debug.sh

fix-server:
	@echo "ğŸ”§ Corrigindo problema de 'server already running'..."
	@docker-compose exec web bash -c "bash /app/scripts/fix_server.sh" || echo "âš ï¸ Falha ao executar o fix-server"

server-start:
	@echo "ğŸš€ Iniciando servidor Rails..."
	@docker-compose exec web bash -c "cd /app && bash scripts/server_management.sh start"

server-stop:
	@echo "ğŸ›‘ Parando servidor Rails..."
	@docker-compose exec web bash -c "cd /app && bash scripts/server_management.sh stop"

server-restart:
	@echo "ğŸ”„ Reiniciando servidor Rails..."
	@docker-compose exec web bash -c "cd /app && bash scripts/server_management.sh restart"

server-status:
	@echo "ğŸ” Verificando status do servidor Rails..."
	@docker-compose exec web bash -c "cd /app && bash scripts/server_management.sh status"