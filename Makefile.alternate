# Makefile para o projeto Genius360 - Vers√£o com indenta√ß√£o corrigida

.PHONY: all up down ps fix-server start exec shell logs rails-console db-console db-migrate db-reset server-status server-start server-stop server-restart help

# Valor padr√£o para a porta
port ?= 3000

# Docker Compose
DOCKER_COMPOSE = docker-compose

# Diret√≥rio de scripts
SCRIPTS_DIR = .scripts

all:
	@echo "Comandos dispon√≠veis:"
	@echo "  make up           - Inicia os servi√ßos em background"
	@echo "  make down         - Para todos os containers"
	@echo "  make ps           - Lista os containers em execu√ß√£o"
	@echo "  make fix-server   - Corrige problema 'server already running'"
	@echo "  make start        - Inicia o servidor Rails"
	@echo "  make exec         - Inicia os containers e abre o console web"
	@echo "  make shell        - Abre o terminal no container web"
	@echo "  make logs         - Exibe os logs dos containers"
	@echo "  make rails-console- Abre o console Rails"
	@echo "  make db-console   - Abre o console PostgreSQL"
	@echo "  make db-migrate   - Executa migra√ß√µes do banco de dados"
	@echo "  make db-reset     - Recria o banco de dados"
	@echo "  make help         - Exibe os comandos dispon√≠veis"

up:
	@echo "üöÄ Iniciando servi√ßos..."
	@$(DOCKER_COMPOSE) up -d

down:
	@echo "üõë Parando servi√ßos..."
	@$(DOCKER_COMPOSE) down

ps:
	@$(DOCKER_COMPOSE) ps

fix-server:
	@echo "üîß Corrigindo problema de 'server already running'..."
	@$(DOCKER_COMPOSE) exec web bash -c "rm -f /app/tmp/pids/server.pid" || echo "‚ö†Ô∏è N√£o foi poss√≠vel remover o arquivo PID"
	@echo "‚úÖ Arquivo PID removido"

start:
	@echo "üöÄ Iniciando servidor Rails..."
	@make fix-server
	@$(DOCKER_COMPOSE) exec web bash -c "cd /app && bundle exec rails s -p $(port) -b '0.0.0.0' -d"
	@echo "‚úÖ Servidor Rails iniciado na porta $(port)"
	@echo "üåê Acesse: http://localhost:$(port)"

exec:
	@echo "üöÄ Iniciando ambiente Genius360..."
	@$(DOCKER_COMPOSE) up -d
	@echo "‚è≥ Aguardando servi√ßos..."
	@sleep 5
	@echo "üîç Verificando status do container web..."
	@$(DOCKER_COMPOSE) exec web bash

shell:
	@echo "üêö Abrindo terminal no container web..."
	@$(DOCKER_COMPOSE) exec web bash

logs:
	@$(DOCKER_COMPOSE) logs -f

rails-console:
	@echo "üõ§Ô∏è Abrindo console Rails..."
	@$(DOCKER_COMPOSE) exec web rails console

db-console:
	@echo "üóÑÔ∏è Abrindo console PostgreSQL..."
	@$(DOCKER_COMPOSE) exec postgres psql -U postgres -d genius360_development

db-migrate:
	@echo "üîÑ Executando migra√ß√µes do banco de dados..."
	@$(DOCKER_COMPOSE) exec web rails db:migrate

db-reset:
	@echo "‚ö†Ô∏è Recriando banco de dados... ‚ö†Ô∏è"
	@$(DOCKER_COMPOSE) exec web rails db:drop db:create db:migrate db:seed

help:
	@echo "Comandos dispon√≠veis:"
	@echo "  make start           - Inicia o servidor Rails na porta padr√£o (3000)"
	@echo "  make start port=3001 - Inicia o servidor Rails na porta espec√≠fica indicada"
	@echo "  make up              - Inicia os servi√ßos em background"
	@echo "  make down            - Para todos os containers"
	@echo "  make ps              - Lista os containers em execu√ß√£o"
	@echo "  make logs            - Exibe os logs dos containers"
